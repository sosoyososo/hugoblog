---
title: '看《一种基于快速GeoHash实现海量商品与商圈高效匹配的算法》所想'
date: Tue, 17 Jul 2018 12:34:48 +0000
draft: false
tags: ['折腾', '瞎逼逼']
---

看到咸鱼技术分享的一个文章 [一种基于快速GeoHash实现海量商品与商圈高效匹配的算法](https://mp.weixin.qq.com/s/2B-VJ2xgwxrmsSkE6zuoPA)，解决的是海量商品区域归属问题。具体做法是： 1. 给商品经纬度进行点数据GeoHash编码 2. 找到目标区域Polygon的最小外接矩形MBR 3. 以MBR左下角(西南角)为基准，向上向右，排列大小一致的小矩形，直到完全超出MBR 4. 剔除跟Polygon完全不相交的外部矩形，分别标记相交矩形和内部不相交矩形 5. 因为每个小矩形大小一致，可以用左下角位置的GeoHash编码来定义这个小矩形的区域 6. 将商品进行2-5步骤的编码，得到唯一的GeoHash编码 7. 将区域进行2-5步骤编码，得到GeoHash编码数组 8. 6和7进行对比，如果完全包含，就确定是这个商圈。如果所在区域被分割，再进行几何学计算，最终得出结果 其实感觉GeoHash编码部分稍显复杂，必要性需要再次考虑一下。 第一次看到GeoHash以及后续使用的时候，有点不想看，就想了一下自己做的话，可能的实现思路： 预处理： 1. 根据经纬度的某个精度分格子 2. 计算每个格子是否被分割线经过 3. 如果没有经过，计算属于哪个区间 4. 如果经过，对于这个格子回到第一步，进一步分割计算，直到达到要求精度。 商品归属计算： 1. 根据经纬度，O(1)获取对应的格子。 2. 如果格子有区域归属，计算结束。 3. 如果被分割，获取格子对应的小格子，回到第一步递归，直到达到对应精度。 好处： 1. 如果第一步区域划分够小(是内存换来的)，绝大部分商品O(1)时间复杂度可以获取到所在区域。对于所有商品，最差情况时间复杂度是O(N)，N是指预处理阶段递归的层数。 2. 一次计算，后续无忧，计算越多，越精细 坏处： 1. 商圈覆盖比较少的时候，有太多无用计算