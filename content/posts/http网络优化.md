---
title: 'HTTP网络优化'
date: Wed, 28 Feb 2018 08:59:52 +0000
draft: false
tags: ['网络']
---

HTTP 1.X 特点
-----------

1.  每次请求都建立连接
2.  明文传输
3.  header内容多，且多次重复
4.  keep-alive 影响服务性能

这里大致总结了网路上出现过的HTTP相关的优化策略，主要涉及到应用层和HTTP层，HTTP的替换，TCP／TLS优化只是略提。

HTTP数据传输延时发生点
-------------

1.  DNS 查询
2.  TCP握手
3.  TCP的延迟确认
4.  TCP慢启动导致新的连接比旧连接速度慢
5.  Nagel算法为节省头部数据比例，会累积大量tcp数据，一次发送，这有可能导致HTTP数据没有及时发送(很多HTTP程序在tcp设置中仅用nagel算法)
6.  time\_wait导致端口耗尽(现实中比较少发生)，但一旦发生，影响很厉害
7.  串行事务导致的时延
8.  NAT网关超时(IPV4有限，局域网环境借助于NAT路由设备扩展了接入终端设备的数量，NAT设备需要维护一个内部终端连接外部服务器所使用的内部IP:PORT与出去的IP:PORT映射对应关系，这个关系有超时清理机制。不同NAT设备超时值不一样，因此才需要心跳辅助，确保经过NAT设备的连接一直保持，避免因过长的时间被踢掉。)

> time\_wait 是在连接关闭后，保持一段时间2MSL(message segment lifttime 数据包在被抛弃前在网络中最大生存时间，一般是2分钟，但因为网络设备进步，通常会设置更小的值)，保证不会有新的连接在这个端口上建立，并且收到旧连接数据包破坏新的连接。

应用层优化
-----

1.  监控当前网络环境和设备属性：wifi／2g／3g 不同网络下，以及不同尺寸分辨率的设备使用不同清晰度的图片。弱网下手动触发才去下载乳片。
2.  使用CDN

优化DNS
-----

1.  使用HTTPDNS或者DNS-over-HTTPS 客户端需要走IP替换域名的路子，这会导致另外一个问题，就是服务端一个IP下多个域名的问题，解决方案是URL上使用\_\_domain参数，然后配置Nginx，解析获取到域名，发送到不同的域名业务。
2.  使用一个动态更新的IP列表
3.  服务器多地部署，配合动态更新的IP列表，当前位置，运营商等选择最优IP进行连接
4.  选择合适的IP也可以使用ping时间的策略

优化HTTP
------

### 使用 keep-alive

优点: 1. 可以重复使用之前的连接，减少TCP建立连接的次数 缺点: 1. 因为需要保存与客户端建立的连接，如果此链接长时间不用，会导致资源浪费 解决： 在服务端使用 keepalvie timeout 设置 keepalvie 超时时间。

#### TCP的keep alive对比HTTP的keep alive

tcp连接建立后，即使网络断掉，只要两边主机没有重启，连接就还存在，如果一端异常重启，没有关闭连接，另一端的连接会一直存在。TCP的keep alive是一种保活机制，用来确认当前的连接还有效。具体措施是在TCP不再收到数据的时候，会发送保活分组，来确认对方还存在，对方收到服务端发送的保活分组后，对此进行确认。服务端如果多次发送保活，却都没有收到确认，就认为连接中断，抛弃这个连接。

### 请求合并

将多个请求合并为一个进行请求

### 减小请求数据大小

1.  对POST的数据进行Gzip压缩
2.  对请求头进行压缩(Http 1.1 不支持，SPDY 及 Http 2.0 支持。)

### 压缩返回数据

1.  使用Gzip压缩返回的数据
2.  使用更简单的数据格式(使用json替换xml,webp替换png等)

### 大文件支持断点续传

同时缓存Http Resonse 的 ETag 标识，用来判断数据是否修改过

### 使用缓存减少数据请求次数

ETag／If-None-Match／Last-Modified

### 增量更新

安卓可以使用增量更新替换全量更新APK

### 并行连接事务

### 预加载

1.  预连接
2.  预取数据

### 预置数据

1.  将常用的资源文件直接打包，使用合适的机制进行更新
2.  iOS使用NSURLProtocol将网络IO变为本地IO，或者使用其他方式加速请求

使用缓存
----

NSURLProtocol

使用新技术
-----

使用spdy/webp/QUIC/HTTP2

替换HTTP
------

1.  使用Spdy(HTTP2基于Spdy，目前google也开始使用HTTP2) > 多路复用，头部压缩，请求优先级
2.  使用QUIC

### HOLB(线头阻塞(Head-of-line blocking))

TCP协议数据传输需要按序传输，可以理解为FIFO先进先出队列，当前面数据传输丢失后，后续数据单元只能等待。SPDY解决了HTTP层的HOLB，但没有解决TCP层的。QUIC解决了TCP层的HOLB问题，但QUIC的支持度比较低。

优化TLS
-----

1.  使用 BoringSSL 优化 HTTPS 加密算法选择
2.  使用 False Start 加速TLS握手
3.  TLS证书配置优化(合理配置证书链，使用ECC证书(但ECC的支持度并不高))
4.  会话复用(Session Identifier/Session Ticket)
5.  使用OCSP Stapling来验证证书(需要web server 和 ssl库都支持)

优化TCP
-----

服务器端可以调优服务器的TCP拥塞窗口大小、重传超时时间(RTO)、最大传输单元(MTU)等。