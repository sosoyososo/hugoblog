---
title: 'TLS 简单了解'
date: Tue, 27 Feb 2018 04:26:55 +0000
draft: false
tags: ['网络']
---

目前大家都在使用https，https是在tcp和http之间插入tls协议实现的。tcp传输二进制流，http将tcp流按照http的协议格式进行解析，传递http的包头，数据。tls发送端对tcp流进行分包，增加校验码，加密，接收端，解密，校验，合并包，还原到最初状态，使用组件的方式在http上增加了加密传输的功能。 tls协议分为两组协议，一组是握手协议，一组是记录协议。

握手协议(四次握手)
----------

握手协议，通过明文传输，来协商数据传输过程是使用的加密，压缩和验证码算法: 1. client hello ,传输tls协议版本，支持的加密算法和客户端生成的一个随机数(client radom) 2. server hello ,服务端返回确认的加密算法，服务器证书，和服务端生成的一个随机数(server radom) 3. client向CA确认服务端证书有效，生成新的随机数(Premaster secret),使用证书公钥加密(默认是RSA)Premaster secret发送发给服务端 4. 服务端使用加密方式和加密后的Premaster secret获取到真正的Premaster secret，配合client radom与server radom，生成后续对称加密需要的session key。

### DH(Diffie-Hellman)算法

因为整个握手阶段都是明文的，算法是开源的，所以TLS的安全依赖于最后一个密钥的安全。为了增加安全性，引入DH算法，在第三步不再给服务器公钥加密后的随机数，而是双方交换一次各自的参数，自行算出一致的密钥，以此增加tls的安全性。算法原理： 1. C／S共享初始值R，算法F 2. C/S各自生成随机数CR/SR 3. C/S 交换使用算法F和随机数以及初始值R生成的值FCR／FSR 4. C/S使用自己的随机数和交换指FR以及算法F生成一致的最终值FR FCR=F(R,CR)为客户端传输给服务端的数据 FSR=F(R,SR)为服务端传输给客户端的数据 F(FCR,SR)==F(FSR,CR)是最终使用的用来加密数据的密钥 所以算法F需要保证最后一步的成立

恢复对话
----

TLS的握手比较耗时，在因为各种原因TLS连接断开后，可以使用两种方式恢复连接: 1. 客户端传给服务端sessionId，服务端查询到对应的编号，确认加密信息还存在，就不必再进行握手 2. 客户端传给服务端上次会话返回的session ticket,里面加密存储本次会话的对话密钥和加密方法，服务器使用里面的信息进行数据传输而不必握手。 第一种只支持单服务器，但所有浏览器都支持。第二种支持多服务器，但只有部分浏览器支持。

记录协议
----

1.  发送端从HTTP接收到数据后，进行分块，压缩，计算出消息认证码，然后加密，最后将结果输出到TCP
2.  接收端从TCP接收到数据后，解密，验证，解压，合并，然后传给HTTP

使用的压缩方法，加密方法，消息认证方法都是在握手阶段协商的结果。